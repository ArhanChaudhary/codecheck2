#!/bin/bash

# sudo visudo
# cay ALL = (check) NOPASSWD: ALL
# Or run su -c by editing /etc/pam.d/su, see https://www.baeldung.com/linux/run-as-another-user
BASEDIR=$(dirname $0)
WORKDIR=$(sudo -u checker mktemp -d /tmp/codecheck/XXXXXXXXXX)
sudo -u checker chmod 733 $WORKDIR
cd $WORKDIR
sudo -u checker unzip -q $1
rm $1
DEBUG=""

cp $BASEDIR/preload.sh compile
cp $BASEDIR/preload.sh runsolution
cp $BASEDIR/preload.sh runsubmission

while read -r LINE
do
  if [[ $LINE =~ ^prepare\ .* || $LINE =~ ^compile\ .* || $LINE =~ ^process\ .* || $LINE =~ ^prepare\ .* ]] ; then
    echo $LINE >> compile
  elif [[ $LINE =~ ^run\ solution.* || $LINE =~ ^collect\ solution.* ]] ; then
    echo $LINE >> runsolution
  elif [[ $LINE =~ ^run\ .* || $LINE =~ ^collect\ .* || $LINE =~ ^unittest\ .* ]] ; then
    echo $LINE >> runsubmission
  elif [[ $LINE =~ ^debug$ ]] ; then
    DEBUG="true"
  fi
done < script

chown checker compile runsolution runsubmission
sudo -u checker chmod +x compile runsolution runsubmission

sudo -u checker ./compile
sudo -u checker nice -15 ./runsolution
if [[ -z $DEBUG ]] ; then
  rm -rf solution*
fi
sudo -u checker nice -15 ./runsubmission

OUTFILE=$(mktemp /tmp/codecheck/XXXXXXXXXX.zip)
# Otherwise zip tries to read $OUTFILE
cd out
zip -r - . > $OUTFILE 2>/dev/null
cd ../..
if [[ -z $DEBUG ]] ; then
  rm -rf $WORKDIR
fi

echo $OUTFILE

