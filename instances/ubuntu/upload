if [ -z "$1" ] ; then
  echo Usage: `basename $0` user@host, e.g. `basename $0` codecheck@cs123.cs.sjsu.edu
  exit
else
  HOST="$1"
fi

DOMAIN=/opt/glassfish4/glassfish/domains/domain1
CODECHECK_HOME=/opt/codecheck
RSYNC='rsync -v -e "ssh -p 62222"'

TMPDIR=`mktemp -d`

BASE=`dirname $0`
cd $BASE
BASE=`pwd`

cd ../../server
ant war
cp antbuild/codecheck.war $TMPDIR

cd $BASE
jar uf $TMPDIR/codecheck.war WEB-INF/web.xml
eval "$RSYNC $TMPDIR/codecheck.war $HOST:$DOMAIN/autodeploy"
rm $TMPDIR/codecheck.war

cd ../../checker
ant clean
ant jar

cp -a codecheck.jar codecheck.policy comprog runprog runprog.apparmor lib $TMPDIR

cd $BASE
cp codecheck codecheck.jks ../s3.properties $TMPDIR

cd $TMPDIR
eval "$RSYNC -az * $HOST:$CODECHECK_HOME"

cd $BASE
rm -rf $TMPDIR


