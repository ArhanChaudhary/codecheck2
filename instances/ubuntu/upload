DOMAIN=/opt/glassfish4/glassfish/domains/domain1
CODECHECK_HOME=/opt/codecheck

if [ -z "$1" ] ; then
  echo Usage: `basename $0` [-p port] user@host, e.g. `basename $0` codecheck@cs123.cs.sjsu.edu
  exit
else
  HOST="$1"
fi

if [[ "$1" = "-p" ]] ; then
#  RSYNC=`echo \'rsync -v -e \"ssh -p $2\"\'`
  RSYNC="rsync -v -e \"ssh -p $2\""
  shift 2
else
  RSYNC="rsync -v"
fi

TMPDIR=`mktemp -d`

BASE=`dirname $0`
cd $BASE
BASE=`pwd`

cd ../../server
ant war
cp antbuild/codecheck.war $TMPDIR

cd $BASE
jar uf $TMPDIR/codecheck.war WEB-INF/web.xml
eval "$RSYNC $TMPDIR/codecheck.war $HOST:$DOMAIN/autodeploy"
rm $TMPDIR/codecheck.war

cd ../../checker
ant jar

cp -a codecheck codecheck.jar codecheck.policy codecheck.env comprog runprog runprog.apparmor lib ../server/glassfish $TMPDIR

cd $BASE
cp codecheck.jks $TMPDIR
[[ -e ../s3.properties ]] && cp ../s3.properties $TMPDIR

cd $TMPDIR
eval "$RSYNC -az * $HOST:$CODECHECK_HOME"

cd $BASE
rm -rf $TMPDIR
